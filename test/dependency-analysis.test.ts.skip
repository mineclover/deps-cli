/**
 * ì˜ì¡´ì„± ë¶„ì„ ê¸°ëŠ¥ ì „ìš© í…ŒìŠ¤íŠ¸
 */

import { describe, test, expect, beforeAll, afterAll, beforeEach } from "vitest"
import { execSync } from "node:child_process"
import * as fs from "node:fs/promises"
import * as path from "node:path"
import { fileURLToPath } from "node:url"

const __filename = fileURLToPath(import.meta.url)
const __dirname = path.dirname(__filename)

const PROJECT_ROOT = path.resolve(__dirname, "..")
const CLI_PATH = path.join(PROJECT_ROOT, "dist", "bin.js")
const TEST_FIXTURES_DIR = path.join(__dirname, "fixtures", "dependency-tests")

describe("ì˜ì¡´ì„± ë¶„ì„ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸", () => {
  beforeAll(async () => {
    await fs.mkdir(TEST_FIXTURES_DIR, { recursive: true })
  })

  afterAll(async () => {
    await fs.rm(TEST_FIXTURES_DIR, { recursive: true, force: true })
  })

  beforeEach(async () => {
    await fs.rm(TEST_FIXTURES_DIR, { recursive: true, force: true })
    await fs.mkdir(TEST_FIXTURES_DIR, { recursive: true })
  })

  describe("TypeScript ì˜ì¡´ì„± ë¶„ì„", () => {
    test("ES6 import êµ¬ë¬¸ ë¶„ì„", async () => {
      const testFile = path.join(TEST_FIXTURES_DIR, "es6-imports.ts")
      await fs.writeFile(testFile, `
// Named imports
import { useState, useEffect } from "react"
import { join, dirname } from "node:path"

// Default imports
import React from "react"
import axios from "axios"

// Namespace imports
import * as fs from "node:fs"
import * as lodash from "lodash"

// Mixed imports
import Component, { Props } from "./Component"

// Type-only imports
import type { User } from "./types"
import type { Config } from "../config"

// Relative imports
import { utils } from "./utils"
import { helpers } from "../helpers"

export function TestComponent() {
  const [state, setState] = useState(0)

  useEffect(() => {
    fs.readFileSync("test")
    axios.get("/api")
  }, [])

  return React.createElement("div")
}
      `)

      const result = execSync(`node "${CLI_PATH}" analyze "${testFile}"`, {
        encoding: "utf-8"
      })

      const analysis = JSON.parse(result)

      expect(analysis).toHaveProperty("graph")
      expect(analysis.analysisMetadata.filesProcessed).toBe(1)

      // ì˜ì¡´ì„±ì´ ê°ì§€ë˜ì—ˆëŠ”ì§€ í™•ì¸
      const dependencies = Object.keys(analysis.graph)
      expect(dependencies.length).toBeGreaterThan(0)
    })

    test("CommonJS require êµ¬ë¬¸ ë¶„ì„", async () => {
      const testFile = path.join(TEST_FIXTURES_DIR, "commonjs-requires.js")
      await fs.writeFile(testFile, `
// Basic require
const fs = require("fs")
const path = require("path")

// Destructuring require
const { join, dirname } = require("node:path")
const { readFile, writeFile } = require("node:fs/promises")

// Relative requires
const utils = require("./utils")
const config = require("../config/app")

// Dynamic require
const handler = require(\`./handlers/\${type}\`)

// Conditional require
if (process.env.NODE_ENV === "development") {
  const debug = require("debug")
  debug.enabled = true
}

function processData() {
  const data = fs.readFileSync("input.txt")
  return utils.transform(data)
}

module.exports = { processData }
      `)

      const result = execSync(`node "${CLI_PATH}" analyze "${testFile}"`, {
        encoding: "utf-8"
      })

      const analysis = JSON.parse(result)

      expect(analysis).toHaveProperty("graph")
      expect(analysis.analysisMetadata.filesProcessed).toBe(1)
    })

    test("Dynamic import êµ¬ë¬¸ ë¶„ì„", async () => {
      const testFile = path.join(TEST_FIXTURES_DIR, "dynamic-imports.ts")
      await fs.writeFile(testFile, `
export async function loadModule() {
  // Dynamic import
  const { default: moment } = await import("moment")

  // Conditional dynamic import
  if (typeof window !== "undefined") {
    const { default: Chart } = await import("chart.js")
    return Chart
  }

  // Dynamic import with variable
  const moduleName = "lodash"
  const lodash = await import(moduleName)

  // Dynamic import for lazy loading
  const Component = lazy(() => import("./components/LazyComponent"))

  return moment()
}

// Top-level await with dynamic import
const config = await import("./config.json")
      `)

      const result = execSync(`node "${CLI_PATH}" analyze "${testFile}"`, {
        encoding: "utf-8"
      })

      const analysis = JSON.parse(result)

      expect(analysis).toHaveProperty("graph")
      expect(analysis.analysisMetadata.filesProcessed).toBe(1)
    })
  })

  describe("ì˜ì¡´ì„± ìœ í˜• ë¶„ë¥˜", () => {
    test("ë‚´ë¶€/ì™¸ë¶€/ë‚´ì¥ ëª¨ë“ˆ ë¶„ë¥˜", async () => {
      // í”„ë¡œì íŠ¸ êµ¬ì¡° ìƒì„±
      const srcDir = path.join(TEST_FIXTURES_DIR, "src")
      await fs.mkdir(srcDir, { recursive: true })

      // ë‚´ë¶€ ëª¨ë“ˆë“¤
      await fs.writeFile(path.join(srcDir, "utils.ts"), `
export function formatDate(date: Date): string {
  return date.toISOString()
}
      `)

      await fs.writeFile(path.join(srcDir, "config.ts"), `
export const API_URL = "https://api.example.com"
      `)

      // ë©”ì¸ íŒŒì¼ - ë‹¤ì–‘í•œ ì˜ì¡´ì„± ìœ í˜•
      await fs.writeFile(path.join(srcDir, "main.ts"), `
// ë‚´ì¥ ëª¨ë“ˆ
import * as fs from "node:fs"
import * as path from "node:path"
import { EventEmitter } from "node:events"

// ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬
import axios from "axios"
import { format } from "date-fns"
import React from "react"

// ë‚´ë¶€ ëª¨ë“ˆ
import { formatDate } from "./utils"
import { API_URL } from "./config"

// íƒ€ì… ì „ìš© import
import type { AxiosResponse } from "axios"

export class ApiClient extends EventEmitter {
  async fetchData(): Promise<AxiosResponse> {
    const configPath = path.join(__dirname, "config.json")
    const configData = fs.readFileSync(configPath, "utf-8")

    return axios.get(\`\${API_URL}/data\`)
  }

  formatTimestamp(date: Date): string {
    return formatDate(date)
  }
}
      `)

      const result = execSync(`node "${CLI_PATH}" classify "${srcDir}" --verbose`, {
        encoding: "utf-8"
      })

      expect(result).toContain("ğŸ“‚ ë°œê²¬ëœ íŒŒì¼ ë¶„ë¥˜ ì‹œì‘...")
      expect(result).toContain("ğŸ“Š ì˜ì¡´ì„± ë¶„ë¥˜ ë¶„ì„ ê²°ê³¼")
      expect(result).toContain("ğŸ“ ì´ íŒŒì¼:")
      expect(result).toContain("ğŸ”— ì´ ì˜ì¡´ì„±:")
      expect(result).toContain("ğŸ“‹ ë…¸ë“œ íƒ€ì…ë³„ ë¶„í¬:")

      // ì—¬ëŸ¬ íŒŒì¼ì´ ë¶„ì„ë˜ì—ˆëŠ”ì§€ í™•ì¸
      const filesMatch = result.match(/ğŸ“ ì´ íŒŒì¼: (\d+)ê°œ/)
      expect(filesMatch).toBeTruthy()
      expect(parseInt(filesMatch![1])).toBeGreaterThanOrEqual(3)
    })

    test("í…ŒìŠ¤íŠ¸ íŒŒì¼ ê°ì§€", async () => {
      const testsDir = path.join(TEST_FIXTURES_DIR, "tests")
      await fs.mkdir(testsDir, { recursive: true })

      // í…ŒìŠ¤íŠ¸ íŒŒì¼ë“¤
      await fs.writeFile(path.join(testsDir, "utils.test.ts"), `
import { describe, test, expect } from "vitest"
import { formatDate } from "../src/utils"

describe("utils", () => {
  test("formatDate", () => {
    const date = new Date("2024-01-01")
    expect(formatDate(date)).toBe("2024-01-01T00:00:00.000Z")
  })
})
      `)

      await fs.writeFile(path.join(testsDir, "api.spec.ts"), `
import { beforeEach, afterEach, jest } from "@jest/globals"
import { ApiClient } from "../src/main"

describe("ApiClient", () => {
  let apiClient: ApiClient

  beforeEach(() => {
    apiClient = new ApiClient()
  })

  afterEach(() => {
    jest.clearAllMocks()
  })
})
      `)

      const result = execSync(`node "${CLI_PATH}" classify "${TEST_FIXTURES_DIR}" --verbose`, {
        encoding: "utf-8"
      })

      expect(result).toContain("ğŸ“‹ ë…¸ë“œ íƒ€ì…ë³„ ë¶„í¬:")
      expect(result).toContain("ğŸ§ª test:") // í…ŒìŠ¤íŠ¸ íŒŒì¼ì´ ê°ì§€ë˜ì—ˆëŠ”ì§€ í™•ì¸
    })
  })

  describe("ë³µì¡í•œ ì˜ì¡´ì„± êµ¬ì¡°", () => {
    test("ìˆœí™˜ ì˜ì¡´ì„± ê°ì§€", async () => {
      const srcDir = path.join(TEST_FIXTURES_DIR, "circular")
      await fs.mkdir(srcDir, { recursive: true })

      // ìˆœí™˜ ì˜ì¡´ì„± êµ¬ì¡° ìƒì„±
      await fs.writeFile(path.join(srcDir, "moduleA.ts"), `
import { functionB } from "./moduleB"

export function functionA() {
  return "A: " + functionB()
}
      `)

      await fs.writeFile(path.join(srcDir, "moduleB.ts"), `
import { functionA } from "./moduleA"

export function functionB() {
  return "B: " + functionA()
}
      `)

      await fs.writeFile(path.join(srcDir, "index.ts"), `
import { functionA } from "./moduleA"
import { functionB } from "./moduleB"

export { functionA, functionB }
      `)

      const result = execSync(`node "${CLI_PATH}" analyze "${srcDir}" --verbose`, {
        encoding: "utf-8"
      })

      const lines = result.split("\n")
      const jsonStart = lines.findIndex(line => line.trim().startsWith("{"))
      const jsonContent = lines.slice(jsonStart).join("\n")
      const analysis = JSON.parse(jsonContent)

      expect(analysis).toHaveProperty("graph")
      expect(analysis.analysisMetadata.filesProcessed).toBe(3)
    })

    test("ê¹Šì€ ì˜ì¡´ì„± ì²´ì¸", async () => {
      const srcDir = path.join(TEST_FIXTURES_DIR, "deep-deps")
      await fs.mkdir(srcDir, { recursive: true })

      // ê¹Šì€ ì˜ì¡´ì„± ì²´ì¸ ìƒì„± (A -> B -> C -> D -> E)
      await fs.writeFile(path.join(srcDir, "moduleA.ts"), `
import { functionB } from "./moduleB"
export const functionA = () => "A" + functionB()
      `)

      await fs.writeFile(path.join(srcDir, "moduleB.ts"), `
import { functionC } from "./moduleC"
export const functionB = () => "B" + functionC()
      `)

      await fs.writeFile(path.join(srcDir, "moduleC.ts"), `
import { functionD } from "./moduleD"
export const functionC = () => "C" + functionD()
      `)

      await fs.writeFile(path.join(srcDir, "moduleD.ts"), `
import { functionE } from "./moduleE"
export const functionD = () => "D" + functionE()
      `)

      await fs.writeFile(path.join(srcDir, "moduleE.ts"), `
export const functionE = () => "E"
      `)

      const result = execSync(`node "${CLI_PATH}" analyze "${srcDir}" --verbose`, {
        encoding: "utf-8"
      })

      expect(result).toContain("ğŸ” Starting analysis of:")
      expect(result).toContain("ğŸ“ Found 5 files to analyze")
      expect(result).toContain("ğŸ“Š Analysis completed:")
    })
  })

  describe("íŠ¹ìˆ˜í•œ import íŒ¨í„´", () => {
    test("Alias ê²½ë¡œ ë¶„ì„", async () => {
      // tsconfig.json ìƒì„±
      await fs.writeFile(path.join(TEST_FIXTURES_DIR, "tsconfig.json"), `
{
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"],
      "@components/*": ["src/components/*"],
      "@utils/*": ["src/utils/*"],
      "@types/*": ["src/types/*"]
    }
  }
}
      `)

      const srcDir = path.join(TEST_FIXTURES_DIR, "src")
      await fs.mkdir(srcDir, { recursive: true })
      await fs.mkdir(path.join(srcDir, "components"), { recursive: true })
      await fs.mkdir(path.join(srcDir, "utils"), { recursive: true })

      await fs.writeFile(path.join(srcDir, "utils", "helpers.ts"), `
export function helper() {
  return "helper"
}
      `)

      await fs.writeFile(path.join(srcDir, "components", "Button.tsx"), `
import React from "react"
import { helper } from "@utils/helpers"

export function Button() {
  return <button>{helper()}</button>
}
      `)

      await fs.writeFile(path.join(srcDir, "App.tsx"), `
import React from "react"
import { Button } from "@components/Button"
import { helper } from "@/utils/helpers"

export function App() {
  return (
    <div>
      <Button />
      {helper()}
    </div>
  )
}
      `)

      const result = execSync(`node "${CLI_PATH}" analyze "${TEST_FIXTURES_DIR}" --verbose`, {
        encoding: "utf-8"
      })

      expect(result).toContain("ğŸ” Starting analysis of:")
      expect(result).toContain("ğŸ“Š Analysis completed:")
    })

    test("Re-export íŒ¨í„´ ë¶„ì„", async () => {
      const srcDir = path.join(TEST_FIXTURES_DIR, "reexports")
      await fs.mkdir(srcDir, { recursive: true })

      // ê°œë³„ ëª¨ë“ˆë“¤
      await fs.writeFile(path.join(srcDir, "moduleA.ts"), `
export const valueA = "A"
export function functionA() { return "funcA" }
      `)

      await fs.writeFile(path.join(srcDir, "moduleB.ts"), `
export const valueB = "B"
export function functionB() { return "funcB" }
      `)

      // Re-export ì¸ë±ìŠ¤ íŒŒì¼
      await fs.writeFile(path.join(srcDir, "index.ts"), `
// Re-exports
export { valueA, functionA } from "./moduleA"
export { valueB, functionB } from "./moduleB"

// Re-export with alias
export { functionA as helperA } from "./moduleA"

// Re-export all
export * from "./moduleB"

// Default re-export
export { default as Module } from "./moduleA"
      `)

      const result = execSync(`node "${CLI_PATH}" analyze "${srcDir}" --verbose`, {
        encoding: "utf-8"
      })

      expect(result).toContain("ğŸ“ Found 3 files to analyze")
      expect(result).toContain("ğŸ“Š Analysis completed:")
    })
  })

  describe("ì„±ëŠ¥ ë° ìµœì í™”", () => {
    test("ë³‘ë ¬ ì²˜ë¦¬ ì„±ëŠ¥", async () => {
      const srcDir = path.join(TEST_FIXTURES_DIR, "parallel-test")
      await fs.mkdir(srcDir, { recursive: true })

      // 20ê°œì˜ íŒŒì¼ ìƒì„± (ì˜ì¡´ì„±ì´ ìˆëŠ”)
      for (let i = 0; i < 20; i++) {
        await fs.writeFile(path.join(srcDir, `file${i}.ts`), `
import { utility } from "./utils"
import * as fs from "node:fs"
import axios from "axios"

export function process${i}() {
  return utility() + ${i}
}

export const config${i} = {
  id: ${i},
  data: fs.readFileSync("config.json", "utf-8")
}
        `)
      }

      await fs.writeFile(path.join(srcDir, "utils.ts"), `
export function utility() {
  return "util"
}
      `)

      const startTime = Date.now()
      const result = execSync(`node "${CLI_PATH}" analyze "${srcDir}" --verbose`, {
        encoding: "utf-8"
      })
      const endTime = Date.now()

      expect(result).toContain("ğŸ“ Found 21 files to analyze")
      expect(result).toContain("ğŸ“Š Analysis completed:")

      // ë³‘ë ¬ ì²˜ë¦¬ë¡œ ì„±ëŠ¥ì´ ê°œì„ ë˜ì—ˆëŠ”ì§€ í™•ì¸ (15ì´ˆ ì´ë‚´)
      expect(endTime - startTime).toBeLessThan(15000)
    })

    test("í° íŒŒì¼ ì²˜ë¦¬", async () => {
      const largeFile = path.join(TEST_FIXTURES_DIR, "large-file.ts")

      // í° íŒŒì¼ ìƒì„± (ë§ì€ importì™€ export)
      let content = `
// Many imports
import * as fs from "node:fs"
import * as path from "node:path"
import * as os from "node:os"
import * as crypto from "node:crypto"
import * as util from "node:util"
import axios from "axios"
import lodash from "lodash"
import moment from "moment"
import React from "react"
import { useState, useEffect, useCallback, useMemo } from "react"

`

      // 100ê°œì˜ í•¨ìˆ˜ ìƒì„±
      for (let i = 0; i < 100; i++) {
        content += `
export function function${i}() {
  const data = fs.readFileSync("file${i}.txt", "utf-8")
  const hash = crypto.createHash("sha256").update(data).digest("hex")
  return \`function${i}: \${hash}\`
}
`
      }

      await fs.writeFile(largeFile, content)

      const startTime = Date.now()
      const result = execSync(`node "${CLI_PATH}" analyze "${largeFile}" --verbose`, {
        encoding: "utf-8"
      })
      const endTime = Date.now()

      expect(result).toContain("ğŸ“ Found 1 files to analyze")
      expect(result).toContain("ğŸ“Š Analysis completed:")

      // í° íŒŒì¼ë„ ì ì ˆí•œ ì‹œê°„ ë‚´ì— ì²˜ë¦¬ë˜ëŠ”ì§€ í™•ì¸ (10ì´ˆ ì´ë‚´)
      expect(endTime - startTime).toBeLessThan(10000)
    })
  })
})